# 시스템 트레이딩을 위한 백테스트 PRD

***

## 1. 제품 개요

- **프로젝트명**: 시스템 트레이딩 백테스트 자동화
- **목표**: 특정 종목의 이동평균선 전략을 백테스트하고, 그 결과를 분석하기 용이한 Excel 파일로 제공한다.

## 2. 사용자 및 범위

- **주요 사용자 (Persona)**: 코딩을 통해 자신만의 투자 전략을 검증하고 싶어하는 개발자 및 개인 투자자.
- **최소 기능 제품 (MVP) 범위**:
    - **대상 종목**: NASDAQ Tesla (TSLA) 1개
    - **적용 전략**: 단기/장기 이동평균선(20일/60일) 골든/데드 크로스 전략 1개
    - **핵심 기능**: 백테스트 실행 및 지정된 포맷의 Excel 결과 파일 생성

## 3. 주요 기능

- 파이썬 라이브러리를 통해 거래소의 OHLCV 데이터 수집
- 이동평균선(단기/장기) 계산 및 매매 신호(골든/데드크로스) 생성
- 매수/매도 시뮬레이션을 통한 백테스트 실행
- 전략별 수익률, MDD(최대 낙폭), 승률 등 핵심 성과 지표 계산
- 백테스트 결과를 Excel 파일로 저장 (시계열 데이터, 성과 지표 요약 포함)

## 4. 요구 사항 상세

- **기술 스택**:
    - **데이터 수집**: yfinance
    - **데이터 처리/분석**: Pandas, NumPy
    - **Excel 출력**: openpyxl 또는 XlsxWriter
    - **설정 관리**: YAML (config.yml)
- **전략 변수 (config.yml)**:
    - **종목**: 'TSLA'
    - **단기/장기 이평 기간**: 20, 60
    - **테스트 기간**: start_date / end_date
    - **최초금액**: $1,000
    - **단위거래금액** : $100 ('full'일 경우 가능한 전체 수량 거래, 단 해당 종목 1주 단가가 단위거래금액을 초과할 경우, 가용 금액 허용 범위안에서 최소 1주 단위 거래)
    - **투자기간** : 2025.01.01 ~ 2025.10.01
    - **기준봉** : 일봉-1Day (분봉 혹은 시간봉 정보도 가능하도록 구현)
- **거래계산**:
    - 매수/매도 진행시 각 캔들의 종가 기준으로 거래가격을 계산    
    - 매수시 주식수는 버림 처리된 정수로 계산한다. 
    - [중요] 매수 신호 처리시, 해당 종목 1주 단가가 단위거래금액을 초과할 경우, 가용 금액 허용 범위안에서 최소 1주 단위 거래 진행 
- **결과 포맷 (Excel)**:
    1. **시계열 데이터 시트**(순서유지):
        - 시가 : 'open', 
        - 고가 :'high', 
        - 저가 : 'low', 
        - 종가 : 'close', 
        - 거래량 : 'volume', 
        - 단기이평선 : 'short_ma', 
        - 장기이평선 : 'long_ma', 
        - 매매신호 : 'trade_signal',  
        - 매매로그 : 'trade_log',  : BUY or SELL
        - 보유주식수 : 'num_stocks' : 매수 주식수, 
        - 매수크기 : 'holding_size'
        - 포지션수익률 : 'holding_return(%)' : 매수가격 대비 현재 PNL
        - 가용잔고 : cash', 
        - 총자산 :  'total_assets'
        - 누적수익률 : 'cumulative_return(%)'
    2. **성과 종합 시트**:
        - **최종 누적 수익률 (%)**
        - **총 거래 횟수 및 승률 (%)**  : 총거래 횟수는 매수를 기준으로 산정하고, 승률은 해당 매수건이 매도 시점에서 수익익인지/손실인지를 계산, 단 매수 후 매도하지 못하는 경우 최종 시점의 PNL을 기준으로 산정
        - **MDD (최대 낙폭)/timestamp**  
        - **CAGR (연평균 복리 수익률)**
        - **샤프 지수 (Sharpe Ratio)**
- **파일구조**
    - 본전략 평가를 위한 백테스트 MVP(Minimum Viable Product) 구현하기위한 것으로, python 코드 단일 파일 구조로 구현합니다.

## 5. 가정 및 제약사항

- **거래 비용**: MVP 버전에서는 거래 수수료 및 슬리피지(slippage)는 **고려하지 않음**.
- **데이터 정확성**: yfinance 라이브러리를 통해 받은 데이터는 모두 정확하다고 가정함.

## 6. 성공 기준

- **MVP 성공 기준**:
    1. 설정 파일(config.yml)을 기반으로 백테스트가 오류 없이 실행된다.
    2. 생성된 Excel 결과 파일의 수치(예: 누적수익률, MDD)가 수동 검산 결과와 일치한다.

## 7. 고려 사항 (비기능 요구 사항)

- **확장성**: 향후 다른 종목이나 새로운 투자 전략(예: RSI, 볼린저 밴드)을 쉽게 추가할 수 있는 구조로 설계한다.
- **유지보수성**: 각 기능(데이터 수집, 전략 계산, 백테스팅)을 모듈화하여 코드의 가독성과 유지보수성을 높인다.
- **에러 처리**: API 연결 실패, 데이터 부재 등 예상되는 오류 발생 시, 원인을 파악할 수 있는 명확한 로그 메시지를 출력한다.


## 8. yfinance 데이터 구조 
- 데이터 컬럼이 (price,ticker :'Close', 'TSLA') 형태의 MultiIndex로 구성되어 있어, 아래와 같이 단순화 필요. 
- 데이터 예시  
'''
Price            Close        High         Low        Open    Volume
Ticker            TSLA        TSLA        TSLA        TSLA      TSLA
Date
2024-09-30  261.630005  264.859985  255.770004  259.040009  80705700
2024-10-01  258.019989  263.980011  248.529999  262.670013  87397600
2024-10-02  249.020004  251.160004  241.500000  247.550003  93983900
2024-10-03  240.660004  249.789993  237.809998  244.479996  80729200
2024-10-04  250.080002  250.960007  244.580002  246.690002  86573200
'''
- 조치방안
    if isinstance(data.columns, pd.MultiIndex):
        data.columns = data.columns.get_level_values(0)